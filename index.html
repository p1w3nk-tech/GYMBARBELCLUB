<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Sistem Member & Pembayaran</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
    h2 { margin-bottom: 10px; }
    nav button { margin: 5px; padding: 10px; }
    .tab { display: none; margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 6px; text-align: center; }
    #loginBox { margin: 50px auto; padding: 20px; width: 300px; background: #fff; border: 1px solid #ccc; }
    #loginBox input { width: 100%; margin-bottom: 10px; padding: 8px; }
    #loginBox button { width: 100%; padding: 8px; }
  </style>
</head>
<body>

  <h2>ðŸ“‹ Sistem Member & Pembayaran</h2>

  <!-- =================== LOGIN =================== -->
  <div id="loginBox">
    <h3>Login</h3>
    <input type="email" id="loginEmail" placeholder="Email" value="admin@app.com">
    <input type="password" id="loginPass" placeholder="Password" value="wulankwan">
    <button onclick="login()">Login</button>
  </div>

  <!-- =================== MAIN CONTENT =================== -->
  <div id="mainContent" style="display:none;">
    <nav>
      <button id="btnMember" onclick="showTab('memberTab')">Database Member</button>
      <button id="btnPayment" onclick="showTab('paymentTab')">Pembayaran</button>
      <button id="btnReport" onclick="showTab('reportTab')">Report Rekap</button>
      <button onclick="logout()">Logout</button>
    </nav>

    <!-- =================== MEMBER =================== -->
    <div id="memberTab" class="tab">
      <h3>Tambah Member</h3>
      <form id="memberForm">
        <label>ID<br><input type="text" id="memberID" required></label><br>
        <label>Nama<br><input type="text" id="memberName" required></label><br>
        <label>Alamat<br><input type="text" id="memberAddress" required></label><br>
        <label>No HP<br><input type="text" id="memberPhone" required></label><br>
        <button type="submit">Simpan Member</button>
      </form>
    </div>

    <!-- =================== PAYMENT =================== -->
    <div id="paymentTab" class="tab">
      <h3>Tambah Pembayaran</h3>
      <form id="paymentForm">
        <label>ID Member<br>
          <input list="memberList" id="payID" required>
          <datalist id="memberList"></datalist>
        </label><br>
        <label>Nama<br><input type="text" id="payName" readonly></label><br>
        <label>Alamat<br><input type="text" id="payAddress" readonly></label><br>
        <label>No HP<br><input type="text" id="payPhone" readonly></label><br>
        <label>Tahun<br><input type="number" id="payYear" required></label><br>
        <label>Bulan<br><input type="number" id="payMonth" min="1" max="12" required></label><br>
        <label>Tanggal Bayar<br><input type="date" id="payDate" required></label><br>
        <button type="submit">Simpan Pembayaran</button>
      </form>
    </div>

    <!-- =================== REPORT =================== -->
    <div id="reportTab" class="tab">
      <h3>Report Rekap (Matrix Janâ€“Des)</h3>
      <label>Tahun <input type="number" id="reportYear" value="2025"></label>
      <button onclick="generateReport()">Tampilkan</button>
      <button onclick="exportExcel()">Export Excel</button>
      <button onclick="window.print()">Print</button>
      <table id="reportTable">
        <thead>
          <tr>
            <th>ID</th><th>Nama</th><th>Alamat</th><th>No HP</th><th>Tahun</th>
            <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>Mei</th><th>Jun</th>
            <th>Jul</th><th>Agu</th><th>Sep</th><th>Okt</th><th>Nov</th><th>Des</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- =================== FIREBASE =================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // âœ… Config Firebase
    const firebaseConfig = {
  apiKey: "AIzaSyCSKjBcT_oc7Lc991ZQehtrZku0r8ocvE8",
  authDomain: "coba-8f9af.firebaseapp.com",
  projectId: "coba-8f9af",
  storageBucket: "coba-8f9af.appspot.com",
  messagingSenderId: "375276847460",
  appId: "1:375276847460:web:f1df0de167aa1612cc7a71",
  measurementId: "G-97Y1D758BR"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const adminEmail = "admin@app.com"; // akun admin

    // =================== LOGIN ===================
    async function login(){
      const email = document.getElementById("loginEmail").value;
      const pass = document.getElementById("loginPass").value;
      try {
        const userCred = await signInWithEmailAndPassword(auth, email, pass);
        const user = userCred.user;

        document.getElementById("loginBox").style.display = "none";
        document.getElementById("mainContent").style.display = "block";

        if(user.email === adminEmail){
          alert("âœ… Login sebagai Admin");
          document.getElementById("btnMember").style.display = "inline-block";
          document.getElementById("btnPayment").style.display = "inline-block";
          showTab("memberTab");
          loadMemberList();
        } else {
          alert("â„¹ï¸ Login sebagai User biasa (Report saja)");
          document.getElementById("btnMember").style.display = "none";
          document.getElementById("btnPayment").style.display = "none";
          showTab("reportTab");
        }

      } catch(err){
        // gagal login â†’ guest (Report saja)
        alert("âŒ Login gagal, masuk sebagai Guest (Report saja)");
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        document.getElementById("btnMember").style.display = "none";
        document.getElementById("btnPayment").style.display = "none";
        showTab("reportTab");
      }
    }
    window.login = login;

    // =================== FORM MEMBER ===================
    document.getElementById("memberForm").addEventListener("submit", async function(e){
      e.preventDefault();
      const data = {
        id: document.getElementById("memberID").value.trim(),
        name: document.getElementById("memberName").value,
        address: document.getElementById("memberAddress").value,
        phone: document.getElementById("memberPhone").value
      };
      try {
        const docRef = await addDoc(collection(db, "members"), data);
        alert("âœ… Member berhasil disimpan!");
        this.reset();
        loadMemberList();
      } catch (err) {
        alert("âŒ Gagal simpan member: " + err.message);
      }
    });

    // =================== AUTO FILL PAYMENT ===================
    async function loadMemberList(){
      const membersSnap = await getDocs(collection(db, "members"));
      const list = document.getElementById("memberList");
      list.innerHTML = "";
      membersSnap.forEach(docSnap=>{
        const m = docSnap.data();
        const option = document.createElement("option");
        option.value = m.id;
        list.appendChild(option);
      });
    }

    document.getElementById("payID").addEventListener("change", async function(){
      const id = this.value.trim();
      if(!id) return;
      const membersSnap = await getDocs(collection(db, "members"));
      let found = null;
      membersSnap.forEach(docSnap=>{
        const m = docSnap.data();
        if(m.id === id){ found = m; }
      });
      if(found){
        document.getElementById("payName").value = found.name;
        document.getElementById("payAddress").value = found.address;
        document.getElementById("payPhone").value = found.phone;
      } else {
        alert("âŒ Member ID tidak ditemukan!");
      }
    });

    // =================== FORM PAYMENT ===================
    document.getElementById("paymentForm").addEventListener("submit", async function(e){
      e.preventDefault();
      const data = {
        id: document.getElementById("payID").value.trim(),
        name: document.getElementById("payName").value,
        address: document.getElementById("payAddress").value,
        phone: document.getElementById("payPhone").value,
        year: parseInt(document.getElementById("payYear").value),
        month: parseInt(document.getElementById("payMonth").value),
        date: document.getElementById("payDate").value
      };
      try {
        await addDoc(collection(db, "payments"), data);
        alert("âœ… Pembayaran berhasil disimpan!");
        this.reset();
      } catch (err) {
        alert("âŒ Gagal simpan pembayaran: " + err.message);
      }
    });

    // =================== REPORT ===================
    async function generateReport(){
      const year = parseInt(document.getElementById("reportYear").value);
      const membersSnap = await getDocs(collection(db,"members"));
      const paymentsSnap = await getDocs(collection(db,"payments"));
      const payments = {};
      paymentsSnap.forEach(doc => {
        const d = doc.data();
        payments[d.id+"-"+d.year+"-"+d.month] = true;
      });

      const tbody = document.querySelector("#reportTable tbody");
      tbody.innerHTML = "";
      membersSnap.forEach(doc=>{
        const m = doc.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${m.id}</td><td>${m.name}</td><td>${m.address}</td><td>${m.phone}</td><td>${year}</td>
          ${[1,2,3,4,5,6,7,8,9,10,11,12].map(mo=>"<td>"+(payments[m.id+"-"+year+"-"+mo]?"âœ”":"-")+"</td>").join("")}
        `;
        tbody.appendChild(row);
      });
    }
    window.generateReport = generateReport;

    // =================== TAB & LOGOUT ===================
    function showTab(tabId){
      document.querySelectorAll(".tab").forEach(t=>t.style.display="none");
      document.getElementById(tabId).style.display="block";
    }
    window.showTab = showTab;

    function logout(){
      signOut(auth).then(()=>{
        alert("Logout berhasil!");
        location.reload();
      });
    }
    window.logout = logout;
  </script>
</body>
</html>