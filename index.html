<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Sistem Member & Pembayaran</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
    nav button { margin: 5px; padding: 8px 12px; }
    .tab { display: none; margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 6px; text-align: center; }
    #loginBox { margin: 50px auto; padding: 20px; width: 300px; background: #fff; border: 1px solid #ccc; }
    #loginBox input { width: 100%; margin-bottom: 10px; padding: 8px; }
    #loginBox button { width: 100%; padding: 8px; }
  </style>
</head>
<body>
  <h2>ðŸ“‹ Sistem Member & Pembayaran</h2>

  <!-- =================== LOGIN =================== -->
  <div id="loginBox">
    <h3>Login</h3>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPass" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>

  <!-- =================== MAIN CONTENT =================== -->
  <div id="mainContent" style="display:none;">
    <nav>
      <button id="btnMember" onclick="showTab('memberTab')">Database Member</button>
      <button id="btnPayment" onclick="showTab('paymentTab')">Pembayaran</button>
      <button id="btnReport" onclick="showTab('reportTab')">Report Rekap</button>
      <button onclick="logout()">Logout</button>
    </nav>

    <!-- =================== MEMBER =================== -->
    <div id="memberTab" class="tab">
      <h3>Tambah / Edit Member</h3>
      <form id="memberForm">
        <input type="hidden" id="memberDocId">
        <label>ID<br><input type="text" id="memberID" required></label><br>
        <label>Nama<br><input type="text" id="memberName" required></label><br>
        <label>Alamat<br><input type="text" id="memberAddress" required></label><br>
        <label>No HP<br><input type="text" id="memberPhone" required></label><br>
        <button type="submit">Simpan</button>
      </form>
      <h4>Daftar Member</h4>
      <table id="memberTable">
        <thead><tr><th>ID</th><th>Nama</th><th>Alamat</th><th>HP</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- =================== PAYMENT =================== -->
    <div id="paymentTab" class="tab">
      <h3>Tambah / Edit Pembayaran</h3>
      <form id="paymentForm">
        <input type="hidden" id="paymentDocId">
        <label>ID Member<br>
          <input list="memberList" id="payID" required>
          <datalist id="memberList"></datalist>
        </label><br>
        <label>Nama<br><input type="text" id="payName" readonly></label><br>
        <label>Alamat<br><input type="text" id="payAddress" readonly></label><br>
        <label>No HP<br><input type="text" id="payPhone" readonly></label><br>
        <label>Tahun<br><input type="number" id="payYear" required></label><br>
        <label>Bulan<br><input type="number" id="payMonth" min="1" max="12" required></label><br>
        <label>Tanggal Bayar<br><input type="date" id="payDate" required></label><br>
        <button type="submit">Simpan</button>
      </form>
      <h4>Daftar Pembayaran</h4>
      <table id="paymentTable">
        <thead><tr><th>ID</th><th>Nama</th><th>Tahun</th><th>Bulan</th><th>Tanggal</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- =================== REPORT =================== -->
    <div id="reportTab" class="tab">
      <h3>Report Rekap (Matrix Janâ€“Des)</h3>
      <label>Tahun <input type="number" id="reportYear" value="2025"></label>
      <button onclick="generateReport()">Tampilkan</button>
      <button onclick="window.print()">Print</button>
      <table id="reportTable">
        <thead>
          <tr>
            <th>ID</th><th>Nama</th><th>Alamat</th><th>No HP</th><th>Tahun</th>
            <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>Mei</th><th>Jun</th>
            <th>Jul</th><th>Agu</th><th>Sep</th><th>Okt</th><th>Nov</th><th>Des</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- =================== FIREBASE =================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ðŸ”‘ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCSKjBcT_oc7Lc991ZQehtrZku0r8ocvE8",
      authDomain: "coba-8f9af.firebaseapp.com",
      projectId: "coba-8f9af",
      storageBucket: "coba-8f9af.appspot.com",   // âœ… diperbaiki
      messagingSenderId: "375276847460",
      appId: "1:375276847460:web:f1df0de167aa1612cc7a71",
      measurementId: "G-97Y1D758BR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const adminEmail = "admin@app.com"; // akun admin

    // =================== LOGIN ===================
    async function login(){
      const email = document.getElementById("loginEmail").value.trim();
      const pass = document.getElementById("loginPass").value.trim();
      try {
        const userCred = await signInWithEmailAndPassword(auth, email, pass);
        const user = userCred.user;

        document.getElementById("loginBox").style.display = "none";
        document.getElementById("mainContent").style.display = "block";

        // ðŸ”‘ cek email admin pakai lowercase
        if (user.email.toLowerCase() === adminEmail.toLowerCase()) {
          alert("âœ… Login sebagai Admin");
          document.getElementById("btnMember").style.display = "inline-block";
          document.getElementById("btnPayment").style.display = "inline-block";
          showTab("memberTab");
          loadMembers();
          loadPayments();
          loadMemberList();
        } else {
          alert("â„¹ï¸ Login berhasil tapi bukan admin â†’ hanya Report");
          document.getElementById("btnMember").style.display = "none";
          document.getElementById("btnPayment").style.display = "none";
          showTab("reportTab");
        }

      } catch(err){
        // === LOGIN GAGAL ===
        alert("âŒ Login gagal, masuk sebagai Guest (Report saja)");
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        document.getElementById("btnMember").style.display = "none";
        document.getElementById("btnPayment").style.display = "none";
        showTab("reportTab");
      }
    }
    window.login = login;

    // =================== CRUD MEMBER ===================
    async function loadMembers(){
      const membersSnap = await getDocs(collection(db, "members"));
      const tbody = document.querySelector("#memberTable tbody");
      tbody.innerHTML = "";
      membersSnap.forEach(docSnap=>{
        const m = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.id}</td>
          <td>${m.name}</td>
          <td>${m.address}</td>
          <td>${m.phone}</td>
          <td>
            <button onclick="editMember('${docSnap.id}','${m.id}','${m.name}','${m.address}','${m.phone}')">Edit</button>
            <button onclick="deleteMember('${docSnap.id}')">Hapus</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    window.loadMembers = loadMembers;

    async function editMember(docId,id,name,address,phone){
      document.getElementById("memberDocId").value = docId;
      document.getElementById("memberID").value = id;
      document.getElementById("memberName").value = name;
      document.getElementById("memberAddress").value = address;
      document.getElementById("memberPhone").value = phone;
    }
    window.editMember = editMember;

    async function deleteMember(docId){
      if(confirm("Yakin hapus member ini?")){
        await deleteDoc(doc(db,"members",docId));
        loadMembers();
      }
    }
    window.deleteMember = deleteMember;

    document.getElementById("memberForm").addEventListener("submit", async function(e){
      e.preventDefault();
      const docId = document.getElementById("memberDocId").value;
      const data = {
        id: document.getElementById("memberID").value.trim(),
        name: document.getElementById("memberName").value,
        address: document.getElementById("memberAddress").value,
        phone: document.getElementById("memberPhone").value
      };
      if(docId){
        await updateDoc(doc(db,"members",docId),data);
      } else {
        await addDoc(collection(db,"members"),data);
      }
      this.reset();
      document.getElementById("memberDocId").value = "";
      loadMembers();
      loadMemberList();
    });

    // =================== AUTO FILL PAYMENT ===================
    async function loadMemberList(){
      const membersSnap = await getDocs(collection(db, "members"));
      const list = document.getElementById("memberList");
      list.innerHTML = "";
      membersSnap.forEach(docSnap=>{
        const m = docSnap.data();
        const option = document.createElement("option");
        option.value = m.id;
        list.appendChild(option);
      });
    }

    document.getElementById("payID").addEventListener("change", async function(){
      const id = this.value.trim();
      if(!id) return;
      const membersSnap = await getDocs(collection(db, "members"));
      let found = null;
      membersSnap.forEach(docSnap=>{
        const m = docSnap.data();
        if(m.id === id){ found = m; }
      });
      if(found){
        document.getElementById("payName").value = found.name;
        document.getElementById("payAddress").value = found.address;
        document.getElementById("payPhone").value = found.phone;
      } else {
        alert("âŒ Member ID tidak ditemukan!");
      }
    });

    // =================== CRUD PAYMENT ===================
    async function loadPayments(){
      const paymentsSnap = await getDocs(collection(db, "payments"));
      const tbody = document.querySelector("#paymentTable tbody");
      tbody.innerHTML = "";
      paymentsSnap.forEach(docSnap=>{
        const p = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.name}</td>
          <td>${p.year}</td>
          <td>${p.month}</td>
          <td>${p.date}</td>
          <td>
            <button onclick="editPayment('${docSnap.id}','${p.id}','${p.name}','${p.address}','${p.phone}',${p.year},${p.month},'${p.date}')">Edit</button>
            <button onclick="deletePayment('${docSnap.id}')">Hapus</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    window.loadPayments = loadPayments;

    async function editPayment(docId,id,name,address,phone,year,month,date){
      document.getElementById("paymentDocId").value = docId;
      document.getElementById("payID").value = id;
      document.getElementById("payName").value = name;
      document.getElementById("payAddress").value = address;
      document.getElementById("payPhone").value = phone;
      document.getElementById("payYear").value = year;
      document.getElementById("payMonth").value = month;
      document.getElementById("payDate").value = date;
    }
    window.editPayment = editPayment;

    async function deletePayment(docId){
      if(confirm("Yakin hapus pembayaran ini?")){
        await deleteDoc(doc(db,"payments",docId));
        loadPayments();
      }
    }
    window.deletePayment = deletePayment;

    document.getElementById("paymentForm").addEventListener("submit", async function(e){
      e.preventDefault();
      const docId = document.getElementById("paymentDocId").value;
      const data = {
        id: document.getElementById("payID").value.trim(),
        name: document.getElementById("payName").value,
        address: document.getElementById("payAddress").value,
        phone: document.getElementById("payPhone").value,
        year: parseInt(document.getElementById("payYear").value),
        month: parseInt(document.getElementById("payMonth").value),
        date: document.getElementById("payDate").value
      };
      if(docId){
        await updateDoc(doc(db,"payments",docId),data);
      } else {
        await addDoc(collection(db,"payments"),data);
      }
      this.reset();
      document.getElementById("paymentDocId").value = "";
      loadPayments();
    });

    // =================== REPORT ===================
    async function generateReport(){
      const year = parseInt(document.getElementById("reportYear").value);
      const membersSnap = await getDocs(collection(db,"members"));
      const paymentsSnap = await getDocs(collection(db,"payments"));
      const payments = {};
      paymentsSnap.forEach(doc => {
        const d = doc.data();
        payments[d.id+"-"+d.year+"-"+d.month] = true;
      });

      const tbody = document.querySelector("#reportTable tbody");
      tbody.innerHTML = "";
      membersSnap.forEach(doc=>{
        const m = doc.data();
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${m.id}</td><td>${m.name}</td><td>${m.address}</td><td>${m.phone}</td><td>${year}</td>
          ${[1,2,3,4,5,6,7,8,9,10,11,12].map(mo=>"<td>"+(payments[m.id+"-"+year+"-"+mo]?"âœ”":"-")+"</td>").join("")}
        `;
        tbody.appendChild(row);
      });
    }
    window.generateReport = generateReport;

    // =================== TAB & LOGOUT ===================
    function showTab(tabId){
      document.querySelectorAll(".tab").forEach(t=>t.style.display="none");
      document.getElementById(tabId).style.display="block";
    }
    window.showTab = showTab;

    function logout(){
      signOut(auth).then(()=>{
        location.reload();
      });
    }
    window.logout = logout;
  </script>
</body>
</html>