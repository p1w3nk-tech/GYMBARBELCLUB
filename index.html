<!DOCTYPE html>
window.fillMemberData = async function(){
const id = document.getElementById('payID').value.trim();
if(!id){ document.getElementById('payName').value = ''; document.getElementById('payAddress').value=''; document.getElementById('payPhone').value=''; return; }
const mSnap = await getDoc(doc(membersCol, id));
const m = mSnap.exists() ? mSnap.data() : null;
document.getElementById('payName').value = m ? m.name : '';
document.getElementById('payAddress').value = m ? m.address : '';
document.getElementById('payPhone').value = m ? m.phone : '';
}


window.editPayment = async function(id, year, month){
const key = `${id}_${year}_${month}`;
const pSnap = await getDoc(doc(paymentsCol, key));
if(!pSnap.exists()) return;
const p = pSnap.data();
document.getElementById('payID').value = p.id;
document.getElementById('payName').value = p.name;
document.getElementById('payAddress').value = p.address;
document.getElementById('payPhone').value = p.phone;
document.getElementById('payYear').value = p.year;
document.getElementById('payMonth').value = p.month;
document.getElementById('payDate').value = p.date;
showTab('tab-payment');
}


window.deletePayment = async function(id, year, month){
if(!confirm('Hapus pembayaran ini?')) return;
const key = `${id}_${year}_${month}`;
await deleteDoc(doc(paymentsCol, key));
}


/*******************************
* 5) Report
******************************/
window.generateReport = async function(){
const year = Number(document.getElementById('filterYear').value);
const tbody = document.querySelector('#reportTable tbody');
tbody.innerHTML = '';
if(!year){ alert('Masukkan Tahun terlebih dahulu!'); return; }


// ambil semua member
const membersSnap = await getDocs(query(membersCol, orderBy('id')));
const membersData = membersSnap.docs.map(d => d.data());


// ambil pembayaran tahun tsb
const paysSnap = await getDocs(query(paymentsCol, where('year','==', year)));
const paidSet = new Set(paysSnap.docs.map(d => {
const p = d.data();
return `${p.id}|${p.year}|${p.month}`;
}));


for(const m of membersData){
let html = `<td>${m.id}</td><td>${m.name}</td><td>${m.address}</td><td>${m.phone}</td><td>${year}</td>`;
for(let i=1;i<=12;i++){
const checked = paidSet.has(`${m.id}|${year}|${i}`) ? 'checked' : '';
html += `<td class='center'><input type='checkbox' ${checked} disabled></td>`;
}
const tr = document.createElement('tr');
tr.innerHTML = html;
tbody.appendChild(tr);
}
}


window.exportExcel = function(){
const wb = XLSX.utils.table_to_book(document.getElementById('reportTable'), {sheet:'Report'});
XLSX.writeFile(wb, 'Report.xlsx');
}


// Default tab
showTab('tab-report');
</script>
</body>
</html>